'use strict'

const sql = require('./')
// const wtf = require('wtfnode')

const sqlConfig = {
  password: 'Upper_l0wercase',
  database: 'di_production',
  // connectionTimeout: undefined,
  // requestTimeout: 30000,
  stream: false,
  options: { encrypt: true },
  port: 1433,
  user: 'sa',
  server: 'localhost',
  pool: {
    acquireTimeoutMillis: 1000,
    propagateCreateError: true
  }
}

let count = 0

function badUUIDReq (pool) {
  const req = pool.request()
  req.input('id', sql.UniqueIdentifier, 'foobar')
  return req.query("select * from TestUniqueId where id = @id").catch((e) => {
    console.log('Request threw exception', e)
    if (count++ < 15) {
      return badUUIDReq(pool)
    } else {
      throw e
    }
  })
}

function main () {
  sql.connect(sqlConfig).then((connection) => {
    return badUUIDReq(connection)
  }).then((result) => {
    console.dir(result)
  }).then(() => sql.close()).catch(() => {
    return sql.close()
  })
}

main()
